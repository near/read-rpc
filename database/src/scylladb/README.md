# Database

This is a helper crate that provides Scylla db manager.

Set up local ScyllaDB
```
$ docker run --name some-scylla -p 9042:9042 --hostname some-scylla -d scylladb/scylla --smp 1
```
### Keyspaces
```
state_indexer - store state changes
tx_indexer - store transactions and receipts
tx_indexer_cache - store transactions and receipts cache
```

### cqlsh

In order to connect to the ScyllaDB cluster and run some queries directly you can use `cqlsh` like so:

```
docker exec -it some-scylla cqlsh

use <keyspace>;
```

### Additional scylla db options
Put int into `.env` file in the service root

```
PREFERRED_DC=dc1
KEEPALIVE_INTERVAL=60
MAX_RETRY=5
STRICT_MODE=true
```

## features

To add debug logs around ScyllaDB queries, run project with `scylla_db_tracing` feature 

Example
```bash
cargo run --release --features scylla_db_tracing
```

Output:
```
+-------------+-------------------------------------------------------------------------------------------------------------------------------------+
| Parameter   | Info                                                                                                                                |
+-------------+-------------------------------------------------------------------------------------------------------------------------------------+
| Client      | 172.17.0.1                                                                                                                          |
+-------------+-------------------------------------------------------------------------------------------------------------------------------------+
| Command     | QUERY                                                                                                                               |
+-------------+-------------------------------------------------------------------------------------------------------------------------------------+
| Coordinator | 172.17.0.2                                                                                                                          |
+-------------+-------------------------------------------------------------------------------------------------------------------------------------+
| Duration    | 159                                                                                                                                 |
+-------------+-------------------------------------------------------------------------------------------------------------------------------------+
| Parameters  | +--------------------------+--------------------------------------------+                                                           |
|             | | Param                    | Value                                      |                                                           |
|             | +--------------------------+--------------------------------------------+                                                           |
|             | | param[0]                 | priceoracle.near                           |                                                           |
|             | +--------------------------+--------------------------------------------+                                                           |
|             | | serial_consistency_level | LOCAL_SERIAL                               |                                                           |
|             | +--------------------------+--------------------------------------------+                                                           |
|             | | consistency_level        | ALL                                        |                                                           |
|             | +--------------------------+--------------------------------------------+                                                           |
|             | | param[1]                 | 01760800000000000000                       |                                                           |
|             | +--------------------------+--------------------------------------------+                                                           |
|             | | query                    | INSERT INTO account_state                  |                                                           |
|             | |                          |                     (account_id, data_key) |                                                           |
|             | |                          |                     VALUES(?, ?)           |                                                           |
|             | +--------------------------+--------------------------------------------+                                                           |
+-------------+-------------------------------------------------------------------------------------------------------------------------------------+
| Request     | Execute CQL3 prepared query [864d2dcb483b704f67db901bc3e5c28e]                                                                      |
+-------------+-------------------------------------------------------------------------------------------------------------------------------------+
| Started at  | P19431DT63742.597S                                                                                                                  |
+-------------+-------------------------------------------------------------------------------------------------------------------------------------+
| Events      | +-----------------------------------------------------------------------------------------+---------+------------+----------------+ |
|             | | Activity                                                                                | Thread  | Source     | Source elapsed | |
|             | +-----------------------------------------------------------------------------------------+---------+------------+----------------+ |
|             | | Checking bounds                                                                         | shard 0 | 172.17.0.2 | 8              | |
|             | +-----------------------------------------------------------------------------------------+---------+------------+----------------+ |
|             | | Processing a statement                                                                  | shard 0 | 172.17.0.2 | 16             | |
|             | +-----------------------------------------------------------------------------------------+---------+------------+----------------+ |
|             | | Creating write handler for token: 2610519484791460873 natural: {172.17.0.2} pending: {} | shard 0 | 172.17.0.2 | 55             | |
|             | +-----------------------------------------------------------------------------------------+---------+------------+----------------+ |
|             | | Creating write handler with live: {172.17.0.2} dead: {}                                 | shard 0 | 172.17.0.2 | 66             | |
|             | +-----------------------------------------------------------------------------------------+---------+------------+----------------+ |
|             | | Executing a mutation locally                                                            | shard 0 | 172.17.0.2 | 79             | |
|             | +-----------------------------------------------------------------------------------------+---------+------------+----------------+ |
|             | | Got a response from /172.17.0.2                                                         | shard 0 | 172.17.0.2 | 114            | |
|             | +-----------------------------------------------------------------------------------------+---------+------------+----------------+ |
|             | | Delay decision due to throttling: do not delay, resuming now                            | shard 0 | 172.17.0.2 | 122            | |
|             | +-----------------------------------------------------------------------------------------+---------+------------+----------------+ |
|             | | Mutation successfully completed                                                         | shard 0 | 172.17.0.2 | 136            | |
|             | +-----------------------------------------------------------------------------------------+---------+------------+----------------+ |
|             | | Done processing - preparing a result                                                    | shard 0 | 172.17.0.2 | 147            | |
|             | +-----------------------------------------------------------------------------------------+---------+------------+----------------+ |
+-------------+-------------------------------------------------------------------------------------------------------------------------------------+
```
